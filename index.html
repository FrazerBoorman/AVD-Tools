<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job Description Simplifier v0.10</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Google OAuth client ID -->
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444; --ok:#22c55e;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c; --ok:#16a34a;
      }
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    .wrap {
      max-width: 1000px;
      margin:0 auto;
      padding:18px 16px 26px;
    }
    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      padding:18px 18px 20px;
      box-shadow:0 18px 40px rgba(15,23,42,0.45);
    }
    h1 {
      margin:0;
      font-size:24px;
      letter-spacing:.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .version-tag {
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      cursor:pointer;
      transition:background .12s ease, border-color .12s ease, color .12s ease, box-shadow .12s ease, transform .06s ease;
    }
    .version-tag:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
      box-shadow:0 4px 10px rgba(15,23,42,0.4);
      transform:translateY(-0.5px);
    }
    .version-tag:focus-visible {
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    .muted { color:var(--muted); font-size:14px; }

    .pill-btn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:transparent;
      cursor:pointer;
      text-decoration:none;
      transition:background .12s ease, border-color .12s ease, color .12s ease, box-shadow .12s ease, transform .06s ease;
    }
    .pill-btn:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
      box-shadow:0 4px 10px rgba(15,23,42,0.4);
      transform:translateY(-0.5px);
    }
    .pill-btn:focus-visible {
      outline:2px solid var(--accent);
      outline-offset:2px;
    }

    .section {
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.65);
      border:1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background:#f9fafb; }
    }
    .section-title {
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }
    label {
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }
    input, select, textarea {
      width:100%;
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
    }
    textarea { resize:vertical; min-height:80px; }
    input::placeholder, textarea::placeholder { color:var(--muted); }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }
    .btn-row { display:flex;flex-wrap:wrap;gap:8px;margin-top:8px; }
    button {
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 13px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:var(--panel);
      color:var(--text);
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    button.primary {
      border-color:var(--accent);
      background:linear-gradient(180deg,var(--accent-soft),transparent);
    }
    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.5);
    }

    .small-note { font-size:11px;color:var(--muted);margin-top:3px; }
    #status, #aiStatus { font-size:12px;color:var(--muted);margin-top:4px; }
    .danger { color:var(--danger); }
    .ok { color:var(--ok); }

    details.debug-panel summary,
    details.advanced summary {
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    #debugOutput {
      margin-top:6px;
      max-height:220px;
      overflow:auto;
      background:var(--panel);
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px;
      font-size:11px;
      white-space:pre-wrap;
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>
            Job Description Simplifier
            <button id="copyVersionBtn" class="version-tag" type="button"
                    title="Copy full index.html to clipboard"
                    aria-label="Copy full index.html to clipboard">v0.10</button>
          </h1>
          <div class="muted">
            Pick an event or paste text, then get a shorter, clearer description that doesn’t lose critical details.
          </div>
        </div>
        <button class="pill-btn" type="button"
                onclick="window.location.href='https://frazerboorman.github.io/';">
          Frazer · AVD Tools
        </button>
      </div>

      <!-- STEP 1 – Calendar selection -->
      <div class="section">
        <div class="section-title">Step 1 – Load events from Google Calendar</div>
        <div class="grid">
          <div>
            <label for="eventSelect">Events</label>
            <select id="eventSelect">
              <option value="">Sign in to load events…</option>
            </select>
            <div id="status">Status: Waiting for sign-in…</div>
            <div id="aiStatus"></div>
          </div>
          <div style="align-self:end;">
            <button id="signinBtn" class="primary" type="button">Sign into Google</button>
            <div class="small-note">
              Same OAuth flow pattern as the other AVD tools.
            </div>
          </div>
        </div>

        <details class="advanced" style="margin-top:10px;">
          <summary>Advanced date range</summary>
          <div class="grid" style="margin-top:8px;">
            <div>
              <label for="advancedStartDate">Start date</label>
              <input id="advancedStartDate" type="date" />
              <div class="small-note">Defaults to 14 days ago.</div>
            </div>
            <div>
              <label for="advancedEndDate">End date</label>
              <input id="advancedEndDate" type="date" />
              <div class="small-note">Defaults to 14 days ahead (future events included).</div>
            </div>
          </div>
          <div class="btn-row" style="margin-top:8px;">
            <button id="applyRangeBtn" type="button">Apply date range</button>
            <div class="small-note">Loads events inside this range (future events included).</div>
          </div>
        </details>
      </div>

      <!-- STEP 2 – Original text -->
      <div class="section">
        <div class="section-title">Step 2 – Original job description</div>
        <div class="grid">
          <div>
            <label for="originalTitle">Title</label>
            <input id="originalTitle" placeholder="Event title will appear here (or type manually)"/>
          </div>
        </div>
        <div style="margin-top:8px;">
          <label for="originalText">Full description / notes</label>
          <textarea id="originalText"
            placeholder="Event description will appear here, including any database dump, access notes, kit details, etc. You can also paste text manually."></textarea>
          <div class="small-note">
            If you don’t pick an event, you can just paste whatever text you want simplified.
          </div>
        </div>
      </div>

      <!-- STEP 3 – Simplify -->
      <div class="section">
        <div class="section-title">Step 3 – Simplify (without losing important details)</div>
        <div class="btn-row">
          <button id="simplifyBtn" class="primary" type="button">Simplify description</button>
          <button id="copyBtn" type="button">Copy simplified text</button>
        </div>
        <div class="small-note">
          Uses the OpenAI key saved below. You only need to set it once per device.
        </div>

        <div style="margin-top:10px;">
          <label for="simplifiedText">Simplified description</label>
          <textarea id="simplifiedText"
            placeholder="AI output will appear here. You can tweak it before copying into the calendar."></textarea>
        </div>
      </div>

      <!-- ADVANCED – API & Calendar settings -->
      <div class="section">
        <details class="advanced">
          <summary>API & Calendar settings (advanced)</summary>
          <div style="margin-top:6px;">
            <div class="grid">
              <div>
                <label for="apiKeyInput">OpenAI API key</label>
                <input id="apiKeyInput" type="password" autocomplete="off" placeholder="sk-..." />
                <div class="small-note">
                  Stored only in this browser via <code>localStorage['avd_job_report_openai_key']</code>.
                </div>
              </div>

              <div>
                <label for="modelSelect">Preferred model (optional)</label>
                <select id="modelSelect"></select>
                <div class="small-note">
                  Uses model candidates + automatic fallback if a model fails.
                </div>
              </div>

              <div>
                <label for="calendarId">Calendar ID</label>
                <input id="calendarId"
                  value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
                <div class="small-note">
                  Calendar used when loading events (same as your other tools).
                </div>
              </div>
            </div>

            <div class="btn-row">
              <button id="saveKeyBtn" type="button">Save key</button>
              <button id="clearKeyBtn" type="button">Clear key</button>
              <button id="testOpenAiBtn" class="primary" type="button">Test OpenAI call</button>
            </div>
            <div id="apiKeyStatus" class="small-note"></div>
          </div>
        </details>
      </div>

      <!-- DEBUG PANEL -->
      <div class="section">
        <details class="debug-panel">
          <summary>Debug log (errors / API responses)</summary>
          <pre id="debugOutput">Debug log initialised…</pre>
        </details>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // TOOL METADATA
    // =========================
    const TOOL_NAME = "Job Description Simplifier";
    const TOOL_VERSION = "v0.10";

    // =========================
    // GOOGLE CALENDAR
    // =========================
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES   = "https://www.googleapis.com/auth/calendar.readonly";

    // =========================
    // OPENAI (shared across AVD tools)
    // =========================
    const OPENAI_KEY_STORAGE = "avd_job_report_openai_key";
    const OPENAI_MODEL_CANDIDATES = [
      "gpt-5.2",
      "gpt-5.2-mini",
      "gpt-5.2-nano",
      "gpt-4.1",
      "gpt-4.1-mini"
    ];

    let tokenClient = null;
    let accessToken = null;
    let currentEvents = [];

    function debugLog(msg, data) {
      const el = document.getElementById("debugOutput");
      if (!el) return;
      const ts = new Date().toISOString();
      let line = "[" + ts + "] " + msg;
      if (data !== undefined) {
        try { line += " " + JSON.stringify(data); }
        catch { line += " " + String(data); }
      }
      el.textContent += "\n" + line;
      el.scrollTop = el.scrollHeight;
    }

    function setStatus(msg, isError) {
      const el = document.getElementById("status");
      if (!el) return;
      el.textContent = "Status: " + msg;
      el.className = isError ? "danger" : "";
      debugLog("STATUS: " + msg + (isError ? " [ERROR]" : ""));
    }
    function setAiStatus(msg, isError) {
      const el = document.getElementById("aiStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.className = isError ? "danger" : "";
      if (msg) debugLog("AI: " + msg + (isError ? " [ERROR]" : ""));
    }

    function setApiKeyStatus(msg, isError) {
      const el = document.getElementById("apiKeyStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.className = "small-note " + (isError ? "danger" : "");
      if (msg) debugLog("APIKEY:
