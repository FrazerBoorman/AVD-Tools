<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Job Description Simplifier v0.1</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Google OAuth client ID -->
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c;
      }
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    .wrap {
      max-width: 1000px;
      margin:0 auto;
      padding:18px 16px 26px;
    }
    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      padding:18px 18px 20px;
      box-shadow:0 18px 40px rgba(15,23,42,0.45);
    }
    h1 {
      margin:0;
      font-size:24px;
      letter-spacing:.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .version-tag {
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
    }
    .muted { color:var(--muted); font-size:14px; }

    .pill-btn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:transparent;
      cursor:pointer;
      text-decoration:none;
    }

    .section {
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.65);
      border:1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background:#f9fafb; }
    }
    .section-title {
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }
    label {
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }
    input, select, textarea {
      width:100%;
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
    }
    textarea { resize:vertical; min-height:80px; }
    input::placeholder, textarea::placeholder { color:var(--muted); }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }
    .btn-row { display:flex;flex-wrap:wrap;gap:8px;margin-top:8px; }
    button {
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 13px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:var(--panel);
      color:var(--text);
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    button.primary {
      border-color:var(--accent);
      background:linear-gradient(180deg,var(--accent-soft),transparent);
    }
    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.5);
    }

    .small-note { font-size:11px;color:var(--muted);margin-top:3px; }
    #status, #aiStatus { font-size:12px;color:var(--muted);margin-top:4px; }
    .danger { color:var(--danger); }

    details.debug-panel summary {
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    #debugOutput {
      margin-top:6px;
      max-height:200px;
      overflow:auto;
      background:var(--panel);
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px;
      font-size:11px;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>
            Job Description Simplifier
            <span class="version-tag">v0.1</span>
          </h1>
          <div class="muted">
            Pick an event or paste text, then get a shorter, clearer description that doesn’t lose critical details.
          </div>
        </div>
        <button class="pill-btn" type="button"
                onclick="window.location.href='https://frazerboorman.github.io/';">
          Frazer · AVD Tools
        </button>
      </div>

      <!-- STEP 0 – OpenAI API key -->
      <div class="section">
        <div class="section-title">Step 0 – OpenAI API key (stored locally)</div>
        <div class="grid">
          <div>
            <label for="apiKeyInput">OpenAI API key</label>
            <input id="apiKeyInput" type="password" autocomplete="off"
                   placeholder="sk-..." />
            <div class="small-note">
              Stored only in this browser via <code>localStorage</code>. Used by the simplifier.
            </div>
          </div>
        </div>
        <div class="btn-row">
          <button id="saveKeyBtn" type="button">Save key</button>
          <button id="clearKeyBtn" type="button">Clear key</button>
        </div>
        <div id="apiKeyStatus" class="small-note"></div>
      </div>

      <!-- STEP 1 – Calendar selection -->
      <div class="section">
        <div class="section-title">Step 1 – Load events from Google Calendar (last 14 days + today)</div>
        <div class="grid">
          <div>
            <label for="calendarId">Calendar ID</label>
            <input id="calendarId"
              value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
            <div class="small-note">
              Same calendar as your other tools.
            </div>
          </div>
          <div>
            <label for="eventSelect">Recent events</label>
            <select id="eventSelect">
              <option value="">Sign in to load events…</option>
            </select>
            <div id="status">Status: Waiting for sign-in…</div>
            <div id="aiStatus"></div>
          </div>
          <div style="align-self:end;">
            <button id="signinBtn" class="primary" type="button">Sign into Google</button>
            <div class="small-note">
              Same OAuth flow pattern as the other AVD tools.
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 2 – Original text -->
      <div class="section">
        <div class="section-title">Step 2 – Original job description</div>
        <div class="grid">
          <div>
            <label for="originalTitle">Title</label>
            <input id="originalTitle" placeholder="Event title will appear here (or type manually)"/>
          </div>
        </div>
        <div style="margin-top:8px;">
          <label for="originalText">Full description / notes</label>
          <textarea id="originalText"
            placeholder="Event description will appear here, including any database dump, access notes, kit details, etc. You can also paste text manually."></textarea>
          <div class="small-note">
            If you don’t pick an event, you can just paste whatever text you want simplified.
          </div>
        </div>
      </div>

      <!-- STEP 3 – Simplify -->
      <div class="section">
        <div class="section-title">Step 3 – Simplify (without losing important details)</div>
        <div class="btn-row">
          <button id="simplifyBtn" class="primary" type="button">Simplify description</button>
          <button id="copyBtn" type="button">Copy simplified text</button>
        </div>
        <div class="small-note">
          Uses the OpenAI key saved above. You only need to set it once per device.
        </div>

        <div style="margin-top:10px;">
          <label for="simplifiedText">Simplified description</label>
          <textarea id="simplifiedText"
            placeholder="AI output will appear here. You can tweak it before copying into the calendar."></textarea>
        </div>
      </div>

      <!-- DEBUG PANEL -->
      <div class="section">
        <details class="debug-panel">
          <summary>Debug log (errors / API responses)</summary>
          <pre id="debugOutput">Debug log initialised…</pre>
        </details>
      </div>
    </div>
  </div>

  <script>
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES   = "https://www.googleapis.com/auth/calendar.readonly";
    const OPENAI_KEY_STORAGE = "avd_job_report_openai_key"; // shared with other tools
    const TEXT_MODEL = "gpt-4o-mini"; // chat-completions-capable model

    let tokenClient = null;
    let accessToken = null;
    let currentEvents = [];

    function debugLog(msg, data) {
      const el = document.getElementById("debugOutput");
      if (!el) return;
      const ts = new Date().toISOString();
      let line = "[" + ts + "] " + msg;
      if (data !== undefined) {
        try {
          line += " " + JSON.stringify(data);
        } catch {
          line += " " + String(data);
        }
      }
      el.textContent += "\n" + line;
      el.scrollTop = el.scrollHeight;
    }

    function setStatus(msg, isError) {
      const el = document.getElementById("status");
      if (!el) return;
      el.textContent = "Status: " + msg;
      el.className = isError ? "danger" : "";
      debugLog("STATUS: " + msg + (isError ? " [ERROR]" : ""));
    }
    function setAiStatus(msg, isError) {
      const el = document.getElementById("aiStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.className = isError ? "danger" : "";
      if (msg) debugLog("AI: " + msg + (isError ? " [ERROR]" : ""));
    }

    function setApiKeyStatus(msg, isError) {
      const el = document.getElementById("apiKeyStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.style.color = isError ? "var(--danger)" : "var(--muted)";
      if (msg) debugLog("APIKEY: " + msg + (isError ? " [ERROR]" : ""));
    }

    function getEventStartDate(ev) {
      if (!ev || !ev.start) return null;
      if (ev.start.date) return new Date(ev.start.date + "T00:00:00Z");
      if (ev.start.dateTime) return new Date(ev.start.dateTime);
      return null;
    }
    function extractEventDate(ev) {
      if (!ev || !ev.start) return "";
      if (ev.start.date) return ev.start.date;
      if (ev.start.dateTime) return ev.start.dateTime.slice(0,10);
      return "";
    }

    function initAuth() {
      debugLog("Initialising Google auth…");
      if (!window.google || !google.accounts || !google.accounts.oauth2) {
        debugLog("Google accounts OAuth2 not available.");
        return;
      }
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: "",
        callback: (resp) => {
          debugLog("Google OAuth callback received", resp);
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            setStatus("Signed in. Loading events…", false);
            loadRecentEvents();
          } else {
            setStatus("Sign-in failed.", true);
          }
        }
      });
    }

    function signInManual() {
      debugLog("Sign-in button clicked.");
      if (!tokenClient) initAuth();
      if (!tokenClient) {
        setStatus("Google auth not ready.", true);
        return;
      }
      tokenClient.requestAccessToken();
    }

    async function loadRecentEvents() {
      if (!accessToken) {
        setStatus("No access token yet.", true);
        return;
      }
      const calId = (document.getElementById("calendarId").value || "primary").trim();
      debugLog("Loading recent events for calendar", calId);

      const now = new Date();
      const end = new Date(now);
      end.setHours(23,59,59,999);
      const start = new Date(now);
      start.setDate(start.getDate() - 14);
      start.setHours(0,0,0,0);

      const url = new URL(
        "https://www.googleapis.com/calendar/v3/calendars/" +
        encodeURIComponent(calId) +
        "/events"
      );
      url.searchParams.set("singleEvents","true");
      url.searchParams.set("orderBy","startTime");
      url.searchParams.set("timeMin", start.toISOString());
      url.searchParams.set("timeMax", end.toISOString());
      url.searchParams.set("maxResults","250");

      try {
        const res = await fetch(url.toString(), {
          headers: { "Authorization":"Bearer " + accessToken }
        });
        debugLog("Calendar fetch response status", res.status);
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          debugLog("Calendar fetch error body", txt);
          setStatus("Calendar API error " + res.status, true);
          return;
        }
        const data = await res.json();
        debugLog("Calendar events raw", { count: (data.items || []).length });

        const items = data.items || [];
        const nowRef = new Date();

        const processed = items
          .map(ev => ({ ev, startDate: getEventStartDate(ev) }))
          .filter(obj => obj.startDate && obj.startDate <= nowRef)
          .sort((a,b) => b.startDate - a.startDate);

        currentEvents = processed.map(x => x.ev);

        const sel = document.getElementById("eventSelect");
        sel.innerHTML = "";
        if (!currentEvents.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No events in last 14 days.";
          sel.appendChild(opt);
          setStatus("No recent events found.", false);
          return;
        }

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "— Select event —";
        sel.appendChild(placeholder);

        currentEvents.forEach((ev, idx) => {
          const title = ev.summary || "(no title)";
          const d = extractEventDate(ev);
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = (d ? (d + " – ") : "") + title;
          sel.appendChild(opt);
        });

        setStatus("Loaded " + currentEvents.length + " events.", false);
      } catch (e) {
        console.error(e);
        debugLog("Error loading events", { error: e.message || String(e) });
        setStatus("Error loading events: " + e.message, true);
      }
    }

    function fillFromSelectedEvent() {
      const sel = document.getElementById("eventSelect");
      if (!sel.value) return;
      const ev = currentEvents[Number(sel.value)];
      if (!ev) return;
      debugLog("Event selected", { title: ev.summary || "", id: ev.id });

      document.getElementById("originalTitle").value = ev.summary || "";
      const bits = [];
      if (ev.description) bits.push(ev.description);
      if (ev.location) bits.push("Location: " + ev.location);
      document.getElementById("originalText").value =
        bits.length ? bits.join("\n\n") : "";
      setStatus("Loaded event details into original fields.", false);
    }

    function getOpenAIKeyOrThrow() {
      const key = localStorage.getItem(OPENAI_KEY_STORAGE);
      if (!key) {
        debugLog("OpenAI key missing in localStorage", OPENAI_KEY_STORAGE);
        throw new Error("No OpenAI API key found. Save it in Step 0.");
      }
      return key;
    }

    async function simplifyDescription() {
      const title = (document.getElementById("originalTitle").value || "").trim();
      const text  = (document.getElementById("originalText").value || "").trim();

      if (!title && !text) {
        setAiStatus("Nothing to simplify. Select an event or paste text first.", true);
        return;
      }

      const combined = "Title: " + title + "\n\nDetails:\n" + text;
      debugLog("Simplify called", { titleLength: title.length, textLength: text.length });

      document.getElementById("simplifyBtn").disabled = true;
      setAiStatus("Talking to OpenAI…", false);

      try {
        const apiKey = getOpenAIKeyOrThrow();
        const systemPrompt =
          "You are simplifying an AV job/event description for an engineer who will read it quickly on their phone.\n\n" +
          "GOAL:\n" +
          "- Rewrite the description so it is shorter, clearer and easier to scan.\n" +
          "- KEEP all important factual details: locations, building names, dates, key constraints, key people, kit names, " +
          "  special requirements, access instructions, and any unusual caveats.\n" +
          "- Remove waffle, repetition, and internal admin noise that doesn’t help someone understand what they’re doing that day.\n\n" +
          "Rules:\n" +
          "- Do NOT invent anything that is not clearly implied by the original text.\n" +
          "- Do NOT drop important instructions just because they sound boring.\n" +
          "- It’s fine to reorder information to improve clarity.\n" +
          "- The output should be suitable for dropping straight into the calendar description.\n\n" +
          "Output:\n" +
          "- A single simplified description (1–3 short paragraphs and/or a few bullet points).\n" +
          "- Do NOT add commentary or labels like 'Summary:' – just the cleaned-up text.";

        const res = await fetch("https://api.openai.com/v1/chat/completions", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + apiKey
          },
          body: JSON.stringify({
            model: TEXT_MODEL,
            messages: [
              { role:"system", content: systemPrompt },
              { role:"user", content: combined }
            ]
          })
        });

        debugLog("OpenAI response status", res.status);

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          debugLog("OpenAI error body", txt);
          throw new Error("OpenAI error " + res.status + " – see debug log.");
        }
        const data = await res.json();
        debugLog("OpenAI response payload (truncated)", {
          hasChoices: !!(data.choices && data.choices.length),
          firstChoiceRole: data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.role
        });
        const choice = data.choices && data.choices[0];
        const outText = choice && choice.message && choice.message.content
          ? choice.message.content
          : "";

        if (!outText) {
          debugLog("OpenAI returned empty content", data);
          throw new Error("OpenAI returned an empty response.");
        }

        document.getElementById("simplifiedText").value = outText;
        setAiStatus("Simplified description ready. Review and tweak if needed.", false);
      } catch (e) {
        console.error("Simplify error:", e);
        debugLog("Simplify error", { error: e.message || String(e) });
        setAiStatus(e.message || "Error simplifying description.", true);
      } finally {
        document.getElementById("simplifyBtn").disabled = false;
      }
    }

    async function copySimplified() {
      const txt = (document.getElementById("simplifiedText").value || "").trim();
      if (!txt) {
        alert("No simplified text to copy yet.");
        return;
      }
      try {
        await navigator.clipboard.writeText(txt);
        alert("Simplified text copied to clipboard.");
        debugLog("Simplified text copied to clipboard.");
      } catch (e) {
        debugLog("Clipboard copy failed", { error: e.message || String(e) });
        alert("Could not copy automatically. You may need to select and copy manually.");
      }
    }

    function loadStoredApiKey() {
      const key = localStorage.getItem(OPENAI_KEY_STORAGE);
      const input = document.getElementById("apiKeyInput");
      if (key && input) {
        input.value = key;
        setApiKeyStatus("API key loaded from local storage.", false);
      } else {
        setApiKeyStatus("No API key saved yet.", false);
      }
    }

    function saveApiKey() {
      const input = document.getElementById("apiKeyInput");
      if (!input) return;
      const val = (input.value || "").trim();
      if (!val) {
        setApiKeyStatus("Cannot save an empty key.", true);
        return;
      }
      localStorage.setItem(OPENAI_KEY_STORAGE, val);
      setApiKeyStatus("API key saved to local storage.", false);
    }

    function clearApiKey() {
      localStorage.removeItem(OPENAI_KEY_STORAGE);
      const input = document.getElementById("apiKeyInput");
      if (input) input.value = "";
      setApiKeyStatus("API key cleared from local storage.", false);
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("signinBtn").addEventListener("click", signInManual);
      document.getElementById("simplifyBtn").addEventListener("click", simplifyDescription);
      document.getElementById("copyBtn").addEventListener("click", copySimplified);
      document.getElementById("eventSelect").addEventListener("change", fillFromSelectedEvent);
      document.getElementById("saveKeyBtn").addEventListener("click", saveApiKey);
      document.getElementById("clearKeyBtn").addEventListener("click", clearApiKey);

      setStatus("Waiting for sign-in…", false);
      debugLog("Page loaded, initialising auth soon…");
      loadStoredApiKey();
      setTimeout(() => { try { initAuth(); } catch(e){ debugLog("initAuth threw", e); } }, 0);
    });
  </script>
</body>
</html>